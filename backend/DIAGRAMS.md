# Flexanon Architecture & Flow Diagrams

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Next.js)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Landing  â”‚  â”‚  Create  â”‚  â”‚  Public  â”‚  â”‚  Dashboard   â”‚   â”‚
â”‚  â”‚   Page   â”‚  â”‚   Flow   â”‚  â”‚ Profile  â”‚  â”‚   (Owner)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• HTTP/JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Express)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Auth Routes   â”‚           â”‚  Share Routes  â”‚               â”‚
â”‚  â”‚  /api/auth/*   â”‚           â”‚  /api/share/*  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚           â†•                            â†•                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚              Services Layer                     â”‚            â”‚
â”‚  â”‚  â€¢ Portfolio Service (SMT builder)             â”‚            â”‚
â”‚  â”‚  â€¢ Share Token Service (DB manager)            â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â†•                            â†•                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Crypto     â”‚           â”‚   Zerion API    â”‚               â”‚
â”‚  â”‚   â€¢ SMT      â”‚           â”‚   Client        â”‚               â”‚
â”‚  â”‚   â€¢ Hashing  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â”‚   â€¢ Signing  â”‚                    â†•                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚                         â”‚
â”‚           â†•                          â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚  â”‚           Database (PostgreSQL)                             â”‚
â”‚  â”‚  â€¢ share_tokens                                             â”‚
â”‚  â”‚  â€¢ sessions                                                 â”‚
â”‚  â”‚  â€¢ wallet_nonces                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
                     External Services
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚    Zerion API           â”‚
                â”‚  (Portfolio Data)       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Create Share Link Flow

```
USER                    FRONTEND                BACKEND                ZERION
 â”‚                         â”‚                       â”‚                      â”‚
 â”‚  1. Connect Wallet      â”‚                       â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                      â”‚
 â”‚                         â”‚                       â”‚                      â”‚
 â”‚  2. Sign Message        â”‚                       â”‚                      â”‚
 â”‚    (prove ownership)    â”‚                       â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                      â”‚
 â”‚                         â”‚  3. POST /auth/verify â”‚                      â”‚
 â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                         â”‚    (signature)        â”‚                      â”‚
 â”‚                         â”‚                       â”‚  4. Verify signature â”‚
 â”‚                         â”‚                       â”‚     âœ“ Valid          â”‚
 â”‚                         â”‚  5. Session Token     â”‚                      â”‚
 â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
 â”‚                         â”‚                       â”‚                      â”‚
 â”‚  6. Set Privacy Options â”‚                       â”‚                      â”‚
 â”‚    [x] Total Value      â”‚                       â”‚                      â”‚
 â”‚    [x] PnL              â”‚                       â”‚                      â”‚
 â”‚    [x] Top 3 Assets     â”‚                       â”‚                      â”‚
 â”‚    [ ] Wallet Address   â”‚                       â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                      â”‚
 â”‚                         â”‚                       â”‚                      â”‚
 â”‚  7. Click "Generate"    â”‚  8. POST /share/gen  â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  9. GET portfolio   â”‚
 â”‚                         â”‚   + session_token     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                         â”‚   + preferences       â”‚                      â”‚
 â”‚                         â”‚                       â”‚  10. Portfolio data  â”‚
 â”‚                         â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                         â”‚                       â”‚                      â”‚
 â”‚                         â”‚                       â”‚  11. Build SMT       â”‚
 â”‚                         â”‚                       â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
 â”‚                         â”‚                       â”‚      â”‚ Leaves:  â”‚    â”‚
 â”‚                         â”‚                       â”‚      â”‚ â€¢ wallet â”‚    â”‚
 â”‚                         â”‚                       â”‚      â”‚ â€¢ value  â”‚    â”‚
 â”‚                         â”‚                       â”‚      â”‚ â€¢ PnL    â”‚    â”‚
 â”‚                         â”‚                       â”‚      â”‚ â€¢ SOL    â”‚    â”‚
 â”‚                         â”‚                       â”‚      â”‚ â€¢ ETH    â”‚    â”‚
 â”‚                         â”‚                       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
 â”‚                         â”‚                       â”‚           â†“          â”‚
 â”‚                         â”‚                       â”‚    12. Select reveal â”‚
 â”‚                         â”‚                       â”‚       â€¢ value âœ“      â”‚
 â”‚                         â”‚                       â”‚       â€¢ PnL âœ“        â”‚
 â”‚                         â”‚                       â”‚       â€¢ SOL âœ“        â”‚
 â”‚                         â”‚                       â”‚       â€¢ wallet âœ—     â”‚
 â”‚                         â”‚                       â”‚           â†“          â”‚
 â”‚                         â”‚                       â”‚    13. Gen proofs    â”‚
 â”‚                         â”‚                       â”‚        for revealed  â”‚
 â”‚                         â”‚                       â”‚           â†“          â”‚
 â”‚                         â”‚                       â”‚    14. Save to DB    â”‚
 â”‚                         â”‚                       â”‚        + merkle_root â”‚
 â”‚                         â”‚                       â”‚        + proofs      â”‚
 â”‚                         â”‚                       â”‚        + token_id    â”‚
 â”‚                         â”‚                       â”‚                      â”‚
 â”‚                         â”‚  15. Share URL        â”‚                      â”‚
 â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
 â”‚  16. Share URL          â”‚  stealth.app/s/abc123 â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚                      â”‚
 â”‚                         â”‚                       â”‚                      â”‚
```

## Public View & Verification Flow

```
PUBLIC USER             FRONTEND                BACKEND
 â”‚                         â”‚                       â”‚
 â”‚  1. Open share link     â”‚                       â”‚
 â”‚    /s/abc123            â”‚                       â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
 â”‚                         â”‚  2. GET /resolve      â”‚
 â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                         â”‚    ?token=abc123      â”‚
 â”‚                         â”‚                       â”‚  3. Read from DB
 â”‚                         â”‚                       â”‚     â€¢ Check expired
 â”‚                         â”‚                       â”‚     â€¢ Check revoked
 â”‚                         â”‚                       â”‚     â€¢ Get revealed leaves
 â”‚                         â”‚                       â”‚     â€¢ Get proofs
 â”‚                         â”‚                       â”‚
 â”‚                         â”‚  4. Public data       â”‚
 â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                         â”‚    {                  â”‚
 â”‚                         â”‚      total: "$50k"    â”‚
 â”‚                         â”‚      pnl: "+143%"     â”‚
 â”‚                         â”‚      assets: [...]    â”‚
 â”‚                         â”‚      wallet: "hidden" â”‚
 â”‚                         â”‚      proofs: [...]    â”‚
 â”‚                         â”‚    }                  â”‚
 â”‚                         â”‚                       â”‚
 â”‚  5. Display Profile     â”‚                       â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
 â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                       â”‚
 â”‚    â”‚ Total: $50,000   â”‚ â”‚                       â”‚
 â”‚    â”‚ PnL: +143.25%    â”‚ â”‚                       â”‚
 â”‚    â”‚ Top Assets:      â”‚ â”‚                       â”‚
 â”‚    â”‚  â€¢ SOL: 10.5     â”‚ â”‚                       â”‚
 â”‚    â”‚  â€¢ ETH: 2.3      â”‚ â”‚                       â”‚
 â”‚    â”‚                  â”‚ â”‚                       â”‚
 â”‚    â”‚ Wallet: [Hidden] â”‚ â”‚                       â”‚
 â”‚    â”‚                  â”‚ â”‚                       â”‚
 â”‚    â”‚ [Verify] button  â”‚ â”‚                       â”‚
 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                       â”‚
 â”‚                         â”‚                       â”‚
 â”‚  6. Click "Verify"      â”‚                       â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
 â”‚                         â”‚  7. For each revealed â”‚
 â”‚                         â”‚     leaf, POST /verifyâ”‚
 â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                         â”‚    {                  â”‚
 â”‚                         â”‚      merkle_root,     â”‚
 â”‚                         â”‚      leaf,            â”‚
 â”‚                         â”‚      proof            â”‚
 â”‚                         â”‚    }                  â”‚
 â”‚                         â”‚                       â”‚  8. Verify proof
 â”‚                         â”‚                       â”‚     hash(leaf)
 â”‚                         â”‚                       â”‚       + siblings
 â”‚                         â”‚                       â”‚       = root? âœ“
 â”‚                         â”‚                       â”‚
 â”‚                         â”‚  9. Valid âœ“           â”‚
 â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                         â”‚                       â”‚
 â”‚  10. Show verification  â”‚                       â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
 â”‚    âœ… All data verified â”‚                       â”‚
 â”‚    against merkle root  â”‚                       â”‚
 â”‚                         â”‚                       â”‚
```

## Sparse Merkle Tree Structure

```
                           ROOT (committed publicly)
                         /                           \
                    HASH(L+R)                      HASH(L+R)
                   /          \                   /          \
              HASH(L+R)    HASH(L+R)         HASH(L+R)    HASH(L+R)
             /      \      /      \          /      \      /      \
         Leaf1   Leaf2  Leaf3  Leaf4     Leaf5   Leaf6  Leaf7  Leaf8
         -----   -----  -----  -----     -----   -----  -----  -----
       wallet   total    PnL   chain      SOL     ETH    BTC   USDC
       HIDDEN REVEALED REVEALED  âœ“     REVEALED HIDDEN HIDDEN REVEALED

       ðŸ”’       ðŸ’°      ðŸ“ˆ       ðŸŒ       â˜€ï¸      ðŸ’Ž      ðŸŸ       ðŸ’µ
```

### Verification Example:

To verify "total_value" leaf:
```
1. Start with: hash(total_value)
2. Get sibling: hash(wallet)
3. Compute parent: hash(wallet + total)
4. Get uncle: hash(PnL + chain)
5. Compute grandparent: hash(parent + uncle)
6. Continue up the tree...
7. Final result = ROOT? âœ… VALID
```

If someone tries to fake the value:
```
1. Start with: hash(fake_value)
2. Get sibling: hash(wallet)
3. Compute parent: hash(wallet + fake)  â† Different!
4. This will never match the ROOT âŒ INVALID
```

## Privacy Levels

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FULL PRIVACY (Paranoid Mode)            â”‚
â”‚  Revealed: Chain only                                      â”‚
â”‚  Hidden: Everything else                                   â”‚
â”‚  Privacy Score: 95%                                        â”‚
â”‚                                                            â”‚
â”‚  Public sees: "Someone on Solana has a portfolio"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BALANCED PRIVACY (Default)              â”‚
â”‚  Revealed: Total value, PnL, Top 3 assets                 â”‚
â”‚  Hidden: Wallet address, other assets                     â”‚
â”‚  Privacy Score: 70%                                        â”‚
â”‚                                                            â”‚
â”‚  Public sees: "$50k portfolio, +143%, holds SOL/ETH/USDC" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MINIMAL PRIVACY (Flex Mode)             â”‚
â”‚  Revealed: Everything including wallet                     â”‚
â”‚  Hidden: Nothing                                           â”‚
â”‚  Privacy Score: 0%                                         â”‚
â”‚                                                            â”‚
â”‚  Public sees: Full portfolio + wallet address              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   share_tokens      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ token_id (PK)       â”‚â—„â”€â”€â”€â”€â”€â”
â”‚ owner_hash          â”‚      â”‚
â”‚ merkle_root         â”‚      â”‚
â”‚ revealed_leaves     â”‚      â”‚
â”‚ proof_data          â”‚      â”‚
â”‚ expires_at          â”‚      â”‚
â”‚ revoked             â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                             â”‚
                             â”‚ Foreign Key
                             â”‚ (via token_id)
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   share_views     â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ id (PK)           â”‚
                    â”‚ token_id (FK)     â”‚
                    â”‚ viewer_ip         â”‚
                    â”‚ user_agent        â”‚
                    â”‚ viewed_at         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sessions          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ session_id (PK)     â”‚
â”‚ wallet_address      â”‚
â”‚ expires_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   wallet_nonces     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ wallet_address (PK) â”‚
â”‚ nonce               â”‚
â”‚ expires_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Request/Response Examples

### Generate Share Link

**Request:**
```http
POST /api/share/generate
Authorization: Bearer abc123session
Content-Type: application/json

{
  "chain": "solana",
  "reveal_preferences": {
    "show_total_value": true,
    "show_pnl": true,
    "show_top_assets": true,
    "top_assets_count": 3,
    "show_wallet_address": false
  },
  "expiry_days": 30
}
```

**Response:**
```json
{
  "success": true,
  "share_url": "https://stealth.app/s/x7k2p9m1",
  "token_id": "x7k2p9m1",
  "merkle_root": "0x7f3e8a9b...",
  "revealed_count": 5,
  "hidden_count": 12,
  "privacy_score": 71,
  "expires_at": "2025-02-15T10:30:00Z"
}
```

### Resolve Public Profile

**Request:**
```http
GET /api/share/resolve?token=x7k2p9m1
```

**Response:**
```json
{
  "token_id": "x7k2p9m1",
  "merkle_root": "0x7f3e8a9b...",
  "committed_at": "2025-01-15T10:30:00Z",
  "revealed_data": {
    "total_value": "$50,000.00",
    "pnl_percentage": "+143.25%",
    "top_assets": [
      {
        "symbol": "SOL",
        "amount": "10.5",
        "value_usd": "2,100.00"
      },
      {
        "symbol": "ETH",
        "amount": "2.3",
        "value_usd": "5,750.00"
      },
      {
        "symbol": "USDC",
        "amount": "15000",
        "value_usd": "15,000.00"
      }
    ],
    "snapshot_time": "2025-01-15T10:30:00Z"
  },
  "proof_data": [...],
  "privacy": {
    "wallet_address": "hidden",
    "total_assets_count": 17,
    "revealed_count": 5
  }
}
```

## Technology Stack

```
Backend Stack:
â”œâ”€â”€ Runtime: Node.js 18+
â”œâ”€â”€ Framework: Express
â”œâ”€â”€ Language: TypeScript
â”œâ”€â”€ Database: PostgreSQL
â”œâ”€â”€ Crypto: Custom SMT implementation
â”œâ”€â”€ APIs: Zerion (portfolio data)
â””â”€â”€ Auth: Wallet signatures (EVM + Solana)

Dependencies:
â”œâ”€â”€ express - Web framework
â”œâ”€â”€ pg - PostgreSQL client
â”œâ”€â”€ axios - HTTP client
â”œâ”€â”€ @ethersproject/wallet - EVM signatures
â”œâ”€â”€ tweetnacl - Solana signatures
â”œâ”€â”€ bs58 - Base58 encoding
â”œâ”€â”€ dotenv - Environment config
â””â”€â”€ tsx - TypeScript runner
```

## Security Considerations

```
âœ… Wallet addresses hashed before storage
âœ… Session tokens expire after 24 hours
âœ… Nonces expire after 5 minutes
âœ… Share links can be revoked
âœ… Share links can expire
âœ… Merkle proofs prevent data tampering
âœ… CORS protection
âœ… Rate limiting (TODO for production)
âœ… Input validation
âœ… SQL injection protection (parameterized queries)
```

---

**This completes the backend implementation!** ðŸŽ‰

All diagrams show the complete flow from wallet connection to public verification.
